# Отладка оплаты звездами

## Проблема: Бесконечная обработка платежа

Если при нажатии на кнопку оплаты происходит бесконечная обработка, проверьте следующее:

### 1. Проверьте настройки API_URL

Убедитесь, что в Netlify (или другом хостинге frontend) правильно настроена переменная окружения:

```
VITE_API_URL=https://your-backend-url.onrender.com
```

**Важно:** 
- URL должен начинаться с `https://`
- URL должен быть доступен публично
- URL должен указывать на ваш backend (Render, Heroku, etc.)

### 2. Проверьте работу backend

Откройте в браузере:
```
https://your-backend-url.onrender.com/health
```

Должен вернуться:
```json
{"status":"ok"}
```

### 3. Проверьте консоль браузера

В Telegram Mini App откройте консоль разработчика (если доступна) и проверьте логи:
- Должны быть логи о создании инвойса
- Должны быть логи о callback от openInvoice
- Должны быть логи о запросе к backend
- Должны быть логи об ошибках (если есть)

### 4. Проверьте структуру платежа

Убедитесь, что:
- Бот имеет доступ к Stars платежам
- Мини-приложение правильно настроено в BotFather
- Пользователь имеет звезды для оплаты

### 5. Проверьте базу данных

Убедитесь, что:
- Таблица `payments` создана
- Таблица `users` существует
- Пользователь создан в базе данных

### 6. Проверьте логи backend

Проверьте логи на Render/Heroku для ошибок:
- Ошибки подключения к базе данных
- Ошибки обработки платежей
- Ошибки валидации данных

## Типичные ошибки

### Ошибка: "Failed to fetch"
**Причина:** Frontend не может подключиться к backend
**Решение:** 
- Проверьте `VITE_API_URL` в Netlify
- Проверьте, что backend работает
- Проверьте CORS настройки на backend

### Ошибка: "Payment already processed"
**Причина:** Платеж уже был обработан ранее
**Решение:** Это нормально, платеж не будет обработан повторно

### Ошибка: "User not found"
**Причина:** Пользователь не создан в базе данных
**Решение:** Убедитесь, что пользователь загружается через `/api/user` endpoint

### Бесконечная обработка
**Возможные причины:**
1. Callback от `openInvoice` не вызывается
2. Backend не отвечает
3. Ошибка в обработке платежа на backend
4. Неправильный `API_URL`

**Решение:**
1. Проверьте логи в консоли браузера
2. Проверьте логи backend
3. Убедитесь, что `API_URL` правильный
4. Проверьте, что backend доступен

## Тестирование

Для тестирования оплаты:
1. Убедитесь, что у вас есть звезды в Telegram
2. Откройте мини-приложение в Telegram
3. Нажмите кнопку "Купить 10000 монет за звезды"
4. Завершите оплату
5. Проверьте, что монеты начислены

## Дополнительная информация

Если проблема не решена:
1. Проверьте все логи (frontend и backend)
2. Убедитесь, что все настройки правильные
3. Проверьте документацию Telegram Stars API
4. Убедитесь, что бот имеет права на обработку платежей

