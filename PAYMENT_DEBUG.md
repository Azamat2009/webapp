# Отладка оплаты звездами

## Важно: Новый подход к оплате

Теперь оплата работает через Telegram Bot API:
1. Пользователь нажимает кнопку в Mini App
2. Backend отправляет инвойс через Bot API в чат с ботом
3. Пользователь оплачивает в чате с ботом
4. Webhook обрабатывает платеж и начисляет монеты

**Убедитесь, что webhook настроен!** См. `WEBHOOK_SETUP.md`

## Проблема: Ошибка при открытии платежной формы

Если при нажатии на кнопку оплаты выдается ошибка, проверьте следующее:

### 1. Проверьте настройки API_URL

Убедитесь, что в Netlify (или другом хостинге frontend) правильно настроена переменная окружения:

```
VITE_API_URL=https://your-backend-url.onrender.com
```

**Важно:** 
- URL должен начинаться с `https://`
- URL должен быть доступен публично
- URL должен указывать на ваш backend (Render, Heroku, etc.)

### 1.1. Проверьте настройки BOT_TOKEN

Убедитесь, что в Render (или другом хостинге backend) правильно настроена переменная окружения:

```
BOT_TOKEN=7739577660:AAGpO1BazLeEkzOZe4vw8jlD7jWMFyp_p8I
```

### 1.2. Проверьте настройки Webhook

Убедитесь, что webhook настроен для бота. См. `WEBHOOK_SETUP.md` для подробных инструкций.

### 2. Проверьте работу backend

Откройте в браузере:
```
https://your-backend-url.onrender.com/health
```

Должен вернуться:
```json
{"status":"ok"}
```

### 3. Проверьте консоль браузера

В Telegram Mini App откройте консоль разработчика (если доступна) и проверьте логи:
- Должны быть логи о создании инвойса
- Должны быть логи о callback от openInvoice
- Должны быть логи о запросе к backend
- Должны быть логи об ошибках (если есть)

### 4. Проверьте структуру платежа

Убедитесь, что:
- Бот имеет доступ к Stars платежам
- Мини-приложение правильно настроено в BotFather
- Пользователь имеет звезды для оплаты

### 5. Проверьте базу данных

Убедитесь, что:
- Таблица `payments` создана
- Таблица `users` существует
- Пользователь создан в базе данных

### 6. Проверьте логи backend

Проверьте логи на Render/Heroku для ошибок:
- Ошибки подключения к базе данных
- Ошибки обработки платежей
- Ошибки валидации данных

## Типичные ошибки

### Ошибка: "Failed to fetch" или "Failed to create invoice"
**Причина:** Frontend не может подключиться к backend или backend не может отправить инвойс
**Решение:** 
- Проверьте `VITE_API_URL` в Netlify
- Проверьте, что backend работает
- Проверьте `BOT_TOKEN` в настройках backend
- Проверьте, что бот может отправлять сообщения пользователю
- Проверьте логи backend на ошибки

### Ошибка: "Payment already processed"
**Причина:** Платеж уже был обработан ранее
**Решение:** Это нормально, платеж не будет обработан повторно

### Ошибка: "User not found"
**Причина:** Пользователь не создан в базе данных
**Решение:** Убедитесь, что пользователь загружается через `/api/user` endpoint

### Ошибка: "Инвойс не отправляется"
**Возможные причины:**
1. Бот не может отправить сообщение пользователю
2. Неправильный `BOT_TOKEN`
3. Пользователь заблокировал бота
4. Backend не может подключиться к Telegram API

**Решение:**
1. Проверьте, что пользователь начал диалог с ботом (отправил `/start`)
2. Проверьте `BOT_TOKEN` в настройках backend
3. Убедитесь, что бот не заблокирован пользователем
4. Проверьте логи backend на ошибки отправки инвойса

### Ошибка: "Платеж не обрабатывается"
**Возможные причины:**
1. Webhook не настроен
2. Webhook не получает обновления от Telegram
3. Ошибка в обработке платежа на backend
4. База данных не работает

**Решение:**
1. Проверьте, что webhook настроен (см. `WEBHOOK_SETUP.md`)
2. Проверьте логи backend на обновления от Telegram
3. Убедитесь, что база данных работает
4. Проверьте, что endpoint `/webhook` доступен публично

## Тестирование

Для тестирования оплаты:
1. **Убедитесь, что webhook настроен** (см. `WEBHOOK_SETUP.md`)
2. Убедитесь, что у вас есть звезды в Telegram
3. Убедитесь, что вы начали диалог с ботом (отправили `/start`)
4. Откройте мини-приложение в Telegram
5. Нажмите кнопку "Купить 10000 монет за звезды"
6. Проверьте чат с ботом - должно прийти сообщение с кнопкой "Pay"
7. Нажмите "Pay" в чате с ботом и завершите оплату
8. Проверьте, что монеты начислены в Mini App
9. Проверьте, что пришло сообщение от бота об успешной оплате

## Дополнительная информация

Если проблема не решена:
1. Проверьте все логи (frontend и backend)
2. Убедитесь, что все настройки правильные
3. Проверьте документацию Telegram Stars API
4. Убедитесь, что бот имеет права на обработку платежей

